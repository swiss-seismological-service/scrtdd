<?xml version="1.0" encoding="UTF-8"?>
<seiscomp>
  <module name="scrtdd" category="Processing" inherit-global-bindings="false">
    <description>
      Double-difference earthquake relocation module.
    </description>
    <configuration>
      <parameter name="automaticOrigins" type="boolean" default="true">
        <description>Allow relocation of automatic origins.</description>
      </parameter>
      <parameter name="manualOrigins" type="boolean" default="true">
        <description>Allow relocation of manual origins.</description>
      </parameter>
      <parameter name="onlyPreferredOrigins" type="boolean" default="true">
        <description>
        Relocate only preferred origins. When disabled, scrtdd processes all
        origins received on the LOCATION messaging group. When enabled, it
        only processes preferred origins from events received on the EVENT group.
        </description>
      </parameter>
      <parameter name="acceptedOriginAuthors" type="list:string" default="">
        <description>
        A comma-separated list of author IDs. Only origins from these authors
        will be considered for relocation. If empty, origins from all authors are
        considered.
        </description>
      </parameter>
      <parameter name="activeProfiles" type="list:string" default="">
        <description>
        Defines a list of active profiles for single-event (real-time) processing.
        </description>
      </parameter>
      <group name="performance">
        <parameter name="delayTime" type="int" default="10" unit="sec">
          <description>
          Specifies a delay in seconds after an origin is created/updated
          to trigger the single-event relocation.
          </description>
        </parameter>
        <parameter name="profileTimeAlive" type="int" default="600" unit="sec">
          <description>
          Defines how long the profile data should be kept in memory (in
          seconds). This is useful to release memory (catalog waveform data)
          after a period of inactivity. A negative value force the profiles to
          stay always in memory.
          </description>
        </parameter>
        <parameter name="cacheWaveforms" type="boolean" default="true">
          <description>
          Save reference catalog waveforms to local disk after they have been
          loaded for the first time. This avoids re-reading them from the
          configured recordStream.
          </description>
        </parameter>
        <parameter name="cacheDirectory" type="path" default="@ROOTDIR@/var/lib/rtdd">
          <description>
          Defines the base directory for the waveform cache. Each profile will
          store its waveforms in a subdirectory named after the profile
          (e.g., @cacheDirectory@/[profile_name]/wfcache).
          </description>
        </parameter>
        <parameter name="cachedWaveformLength" type="double" default="10" unit="sec">
          <description>
          The waveform length (centered around pick time) to be used for the
          disk cache. Although the required waveform length is inferred from
          the cross-correlation settings, this option allows for a longer
          disk-cached trace that is useful if cross-correlation settings
          are changed in the future.
          </description>
        </parameter> 
      </group>
      <group name="profile">
        <description>
        Each profile is a configuration set with an optional region. The region
        is used in real-time processing to select a profile for an incoming origin.
        If an origin falls into multiple profile regions, the profile defined first
        in the 'activeProfiles' list will be used. This allows for hierarchical
        regions, where specific regions are defined first and a broader region is
        defined last. A profile is only active in real-time processing when
        added to the 'activeProfiles' list.
        </description>
        <struct type="rtdd profile" link="rtdd.activeProfiles">
          <parameter name="regionType" type="string" default="CIRCULAR">
            <description>Type of region: RECTANGULAR or CIRCULAR.</description>
          </parameter>
          <parameter name="region" type="list:double">
            <description>
            Optional. If regionType is RECTANGULAR, 4 comma-separated values
            are expected: min_lat, min_lon, max_lat, max_lon. If regionType is
            CIRCULAR, 3 comma-separated values are expected: lat, lon, radius
            in km. If left empty, the region is limitless.
            </description>
          </parameter>
          <parameter name="methodID" type="string" default="RTDD">
            <description>
            The methodID label to be stored in created origins.
            </description>
          </parameter>
          <parameter name="tableType" type="string" default="LOCSAT">
            <description>
            Travel-time table format type (e.g. homogeneous, NLLGrid, LOCSAT).
            </description>
          </parameter>
          <parameter name="tableModel" type="string" default="iasp91">
            <description>
            The model to be used. The format depends on tableType.
            </description>
          </parameter>
          <parameter name="PSTableOnly" type="boolean" default="true">
            <description>
            If enabled, travel-time information is fetched using 'P' and 'S'
            tables only, and the specific phase type (e.g., Pg, Sg, Pn)
            is not considered.
          </description>
          </parameter>
          <parameter name="P-Phases" type="list:string" default="P,Pg,Pn">
            <description>
            A list of accepted P-wave phases. Phases not in this list will be ignored.
            </description>
          </parameter>
          <parameter name="S-Phases" type="list:string" default="S,Sg,Sn">
            <description>
            A list of accepted S-wave phases. Phases not in this list will be ignored.
            </description>
          </parameter>
          <parameter name="pickUncertaintyClasses" type="list:string" unit="s" default="0.000,0.025,0.050,0.100,0.200,0.400" >
            <description>
            Defines pick time uncertainty thresholds (in seconds) used to classify
            picks for weighting. This parameter defines a list of interval boundaries.
            A pick's class is determined by the interval its uncertainty falls into.
            E.g., a pick with an uncertainty of 0.150s falls into the 4th interval
            (between 0.100 and 0.200) and is assigned class 4. If a pick's
            uncertainty is absent, the lowest class is used.
            The pick weight is computed as: 1 / 2^(class-1).
            </description>
          </parameter>
          <group name="catalog">
            <description>
            Define the reference catalog for this profile.
            </description>
            <parameter name="eventFile" type="path">
              <description>
              Path to event file to be used for this profile. If this file 
              contains just one column called "origin", then each line must be an
              existing origin id and neither phase.csv nor station.csv files are
              required. Alternatively the extended format requires all of 
              event.csv, phase.csv and station.csv files to be provided
              </description>
            </parameter>
            <parameter name="phaFile" type="path">
              <description>
              Path to catalog picks file to be used for this profile
              </description>
            </parameter>
            <parameter name="stationFile" type="path">
              <description>
              Path to the stations file to be used for this profile
              </description>
            </parameter>
          </group>
          <group name="doubleDifferenceSystem">
            <description>
            Clustering configuration, which is responsible for selecting the event
            pairs and their phases to be used in the double-difference equation system.
            </description> 
            <group name="eventFiltering">
              <description>
              Exclude poorly connected events (events with not enough phases and/or neighbours).
              </description>
              <parameter name="minNumPhases" type="int" default="8">
                <description>
                Minimum number of phases at common stations required between an
                event pair. Pairs not satisfying this condition will not be used.
                </description>
              </parameter> 
              <parameter name="minNumNeighbours" type="int" default="4">
                <description>
                Minimum number of neighbours required by an event. Events not
                satisfying this condition will not be used in the relocation.
                </description>
              </parameter>
            </group>
            <group name="phaseFiltering">
              <description>Exclude non-optimal phases from the DD system.</description>
              <parameter name="minStationToEventPairDistRatio" type="double" default="3">
                <description>
                Minimum ratio between the event-station distance and the inter-event
                distance. Phases from stations not satisfying this condition will not be used.
                </description>
              </parameter>
              <parameter name="minStationDistance" type="double" unit="km">
                <description>
                Minimum distance (km) between an event and a station for a
                phase to be used. Phases from stations not satisfying this
                condition will not be used.
                </description>
              </parameter>
              <parameter name="maxStationDistance" type="double" unit="km">
                <description>
                Maximum distance (km) between an event and a station for a phase
                to be used. Phases from stations not satisfying this
                condition will not be used. A value of 0 or less disables this limit.
                </description>
              </parameter>
            </group>
            <group name="eventPairSelection">
              <description>
              Controls how neighbouring events are selected. In the simplest
              form, 'numEllipsoids' is set to 0 and neighbours are selected
              on a nearest-neighbor basis within a search distance of
              'maxNeighbourDistance'. When 'numEllipsoids' is not 0, the
              ellipsoid selection algorithm (Waldhauser, 2009) is used to ensure
              spatially homogeneous subsampling. Reference events are selected
              within concentric, vertically elongated ellipsoidal layers of
              increasing thickness. Each layer is split into eight quadrants (cells),
              and neighboring events are selected from each of the resulting cells
              in a round-robin fashion until 'maxNumNeighbours' is reached.
              </description>
              <group name="singleEvent">
                <description>Configuration for single-event relocation.</description>
                <parameter name="maxNumNeighbours" type="int" default="80">
                  <description>
                  Maximum number of neighbors per event. A value of 0 disables this limit.
                  </description>
                </parameter>
                <parameter name="maxNeighbourDistance" type="double" default="5" unit="km">
                  <description>
                  Maximum distance between an event and its neighbouring
                  events. If 'numEllipsoids' is greater than 0, this value is
                  the horizontal axis length (km) of the outermost boundary. Each
                  inner concentric layer axis will be half of the previous one.
                  The vertical axis is twice as long as the horizontal ones.
                  </description>
                </parameter>
                <parameter name="numEllipsoids" type="int" default="5">
                  <description>
                  If set to 0, the nearest-neighbor event selection is used.
                  Otherwise, this is the number of concentric ellipsoidal layers
                  to be used in the neighboring event selection.
                  </description>
                </parameter>
              </group>
              <group name="multiEvent">
                <description>Configuration for multi-event relocation.</description>
                <parameter name="maxNumNeighbours" type="int" default="40">
                  <description>
                  Maximum number of neighbors per event. A value of 0 or less
                  disables this limit.
                  </description>
                </parameter>
                <parameter name="maxNeighbourDistance" type="double" default="5" unit="km">
                  <description>
                  Maximum distance between an event and its neighbouring
                  events. If 'numEllipsoids' is greater than 0, this value is
                  the horizontal axis length (km) of the outermost boundary. Each
                  inner concentric layer axis will be half of the previous one.
                  The vertical axis is twice as long as the horizontal ones.
                  </description>
                </parameter>
                <parameter name="numEllipsoids" type="int" default="0">
                  <description>
                  If set to 0, the nearest-neighbor event selection is used.
                  Otherwise, this is the number of concentric ellipsoidal layers
                  to be used in the neighboring event selection.
                  </description>
                </parameter>
              </group>
            </group>
          </group>
          <group name="crossCorrelation">
            <description>
            Waveform cross-correlation is used to improve the differential travel
            times used in the double-difference system.
            </description>
            <parameter name="enable" type="boolean" default="false">
              <description>
              Enable or disable waveform cross-correlation.
              </description>
            </parameter>
            <parameter name="minStationDistance" type="double" default="0" unit="km">
              <description>
              Minimum allowed distance between event and station. Phases belonging
              to closer stations will not be used in cross-correlation.
              </description> 
            </parameter>
            <parameter name="maxStationDistance" type="double" default="60" unit="km">
              <description>
              Maximum allowed distance between event and station. Phases belonging
              to more distant stations will not be used in cross-correlation.
              A value of -1 or less removes this limit.
              </description>
            </parameter>
            <parameter name="maxInterEventDistance" type="double" default="2" unit="km">
              <description>
              Maximum allowed distance (km) between events for cross-correlation
              to be performed. Phases of event pairs whose inter-event distance is
              greater than this value will not be cross-correlated.
              A value of -1 or less removes this limit.
              </description>
            </parameter>
            <group name="p-phase">
              <parameter name="minCCCoef" type="double" default="0.70">
                <description>
                Minimum cross-correlation coefficient required to use a differential
                travel time derived from cross-correlation.
                </description>
              </parameter>
              <parameter name="winStart" type="double" default="-0.50" unit="sec">
                <description>
                Start of the data window to cross-correlate, relative to the
                pick time (+/- seconds).
                </description>
              </parameter>
              <parameter name="winEnd" type="double" default="0.50" unit="sec">
                <description>
                End of the data window to cross-correlate, relative to the
                pick time (+/- seconds).
                </description>
              </parameter>
              <parameter name="winScaling" type="double" default="0.02">
                <description>
                Window scaling coefficient. The final window length is calculated as:
                Window Length = (winEnd-winStart) + TravelTime * winScaling.
                </description>
              </parameter>
              <parameter name="maxDelay" type="double" default="0.50" unit="sec">
                <description>Maximum lag (in seconds) between data windows allowed.</description>
              </parameter>
              <parameter name="components" type="list:string" default="Z">
                <description>
                Priority list of components to use for cross-correlation (e.g., Z,N,E,1,2,3).
                The first component in the list that exists for both phases is used.
                Special values: 'L2' computes the L2 norm of the horizontal components;
                'T' and 'R' compute the transverse and radial components, respectively,
                relative to the event location. If empty, the component on which the
                phase was picked is used (if identical for both phases).
                </description>
              </parameter>
            </group>
            <group name="s-phase">
              <parameter name="minCCCoef" type="double" default="0.70">
                <description>
                Minimum cross-correlation coefficient required to use a differential
                travel time derived from cross-correlation.
                </description>
              </parameter>
              <parameter name="winStart" type="double" default="-0.50" unit="sec">
                <description>
                Start of the data window to cross-correlate, relative to the
                pick time (+/- seconds).
                </description>
              </parameter>
              <parameter name="winEnd" type="double" default="1.00" unit="sec">
                <description>
                End of the data window to cross-correlate, relative to the
                pick time (+/- seconds).
                </description>
              </parameter>
              <parameter name="winScaling" type="double" default="0.04">
                <description>
                Window scaling coefficient. The final window length is calculated as:
                Window Length = (winEnd-winStart) + TravelTime * winScaling.
                </description>
              </parameter>
              <parameter name="maxDelay" type="double" default="0.50" unit="sec">
                <description>Maximum lag (in seconds) between data windows allowed.</description>
              </parameter>
              <parameter name="components" type="list:string" default="L2">
                <description>
                Priority list of components to use for cross-correlation (e.g., Z,N,E,1,2,3).
                The first component in the list that exists for both phases is used.
                Special values: 'L2' computes the L2 norm of the horizontal components;
                'T' and 'R' compute the transverse and radial components, respectively,
                relative to the event location. If empty, the component on which the
                phase was picked is used (if identical for both phases).
                </description>
              </parameter>
            </group>
            <group name="waveformFiltering">
              <description>
              Filter waveforms before performing cross-correlation.
              </description>
              <parameter name="filterString" type="string" default="">
                <description>
                SeisComP string-based filter definition,
                e.g., "ITAPER(1)>>BW_HLP(2,1,20)". Set to "" to disable filtering.
                </description>
              </parameter>
              <parameter name="margin" type="double" default="1" unit="sec">
                <description>
                Extra seconds of data to add to the waveform ends before applying
                the filter. This helps initialize the filter and allows for
                discarding potential artifacts at the trace ends.
                </description>
              </parameter> 
              <parameter name="resampling" type="double" default="0" unit="Hz">
                <description>
                Resample all traces to this sampling frequency (Hz).
                Set to 0 to disable resampling.
                </description>
              </parameter>
            </group>
          </group>
          <group name="solver">
            <description>
            These options control the double-difference system solver. The
            solution is found through an iterative process: a system is built
            from the initial locations and solved. The hypocenters are then updated,
            and a new system is built and solved again. This is repeated until
            'algoIterations' is reached.
            </description>
            <parameter name="solverType" type="string" default="LSMR">
              <description>Solver algorithm to use: either LSMR or LSQR.</description>
            </parameter>
            <parameter name="algoIterations" type="int" default="20">
              <description>Number of iterations for the solver to perform.</description>
            </parameter>
            <parameter name="downWeightingByResidual" type="list:double" default="10,5" >
              <description>
              Specifies residual thresholds for down-weighting equations. Equations
              with residuals smaller than this value (in standard deviations) are
              down-weighted and the rest discarded (0 weighed). A value of 0 disables
              this. If two values are given, are used for the first and last iterations
              respectively, with intermediate iterations using interpolated values.
              </description>
            </parameter>
            <parameter name="dampingFactor" type="list:double" default="0.01" >
              <description>
              A non-zero value enables a damped (regularized) least-squares
              system.  If two values are given, they are for the first and last iterations,
              with interpolation in between.
              </description>
            </parameter>
            <parameter name="absoluteLocationConstraint" type="list:double" default="0.3" >
              <description>
              If greater than 0, the system is modified to solve for both
              absolute and relative locations by adding equations that constrain
              absolute travel-time residuals. This option sets the weight for
              these equations. If two values are given, they are for the first
              and last iterations, with interpolation in between.
              </description>
            </parameter>
            <parameter name="xcorrWeightScaler" type="double" default="2.0">
              <description>
              Weight scaling factor for equations that use cross-correlation
              differential times relative to equations that use only differential
              pick times. For example, a value of 2 means they are weighted twice
              as much
              </description>
            </parameter>
            <parameter name="usePickUncertainties" type="boolean" default="false">
              <description>
              Whether to use pick time uncertainty to weigh each pick according
              to 'pickUncertaintyClasses'. If enabled, each double-difference
              equation weight will be the average of its constituent pick weights.
              </description>
            </parameter>
          </group>
        </struct>
      </group>
    </configuration>
    <command-line>
      <group name="Generic">
        <optionReference>generic#help</optionReference>
        <optionReference>generic#version</optionReference>
        <optionReference>generic#config-file</optionReference>
        <optionReference>generic#plugins</optionReference>
        <optionReference>generic#daemon</optionReference>
        <optionReference>generic#auto-shutdown</optionReference>
        <optionReference>generic#shutdown-master-module</optionReference>
        <optionReference>generic#shutdown-master-username</optionReference>
      </group>
      <group name="Verbosity">
        <optionReference>verbosity#verbosity</optionReference>
        <optionReference>verbosity#v</optionReference>
        <optionReference>verbosity#quiet</optionReference>
        <optionReference>verbosity#component</optionReference>
        <optionReference>verbosity#syslog</optionReference>
        <optionReference>verbosity#lockfile</optionReference>
        <optionReference>verbosity#console</optionReference>
        <optionReference>verbosity#debug</optionReference>
        <optionReference>verbosity#log-file</optionReference>
      </group>
      <group name="Messaging">
        <optionReference>messaging#user</optionReference>
        <optionReference>messaging#host</optionReference>
        <optionReference>messaging#timeout</optionReference>
        <optionReference>messaging#primary-group</optionReference>
        <optionReference>messaging#subscribe-group</optionReference>
        <optionReference>messaging#content-type</optionReference>
        <optionReference>messaging#start-stop-msg</optionReference>
        <option long-flag="test">
          <description>
          Test mode, no messages are sent when relocating a single event
          </description>
        </option>
      </group>
      <group name="Database">
        <optionReference>database#db-driver-list</optionReference>
        <optionReference>database#database</optionReference>
        <optionReference>database#config-module</optionReference>
        <optionReference>database#inventory-db</optionReference>
        <optionReference>database#db-disable</optionReference>
      </group>
      <group name="Records">
        <optionReference>records#record-driver-list</optionReference>
        <optionReference>records#record-url</optionReference>
        <optionReference>records#record-file</optionReference>
        <optionReference>records#record-type</optionReference>
      </group>
      <group name="Mode">
        <option long-flag="reloc-catalog" argument="profile">
          <description>
          Relocate the catalog passed as argument in multi-event mode. The
          input can be a single file (containing seiscomp origin ids) or a file
          triplet (station.csv,event.csv,phase.csv). For input events stored
          in a XML files add the --ep option. Use in combination with --profile.
          </description>
        </option>
        <option long-flag="origin-id" flag="O" argument="origin-id">
          <description>
          Relocate  the origin (or multiple comma-separated origins) in
          signle-event mode and send a message. Each origin will be processed
          accordingly to the matching profile region unless the --profile option
          is used.
          </description>
        </option>
        <option long-flag="ep" argument="scxml-file">
          <description>
          Relocate contained origins in signle-event mode, unless --reloc-catalog
          is provided. In signle-event mode, each origin will be processed
          accordingly to the matching profile region unless the --profile option is
          used. Together with --reloc-catalog option, the parameters XML file is
          used to fetch the input catalog data.
          </description>
        </option>
        <option long-flag="dump-clusters" argument="profile">
          <description>
          Find clusters in the catalog passed as argument and save them in
          the working directory.
          The catalog can be a single file (containing seiscomp origin
          ids) or a file triplet (station.csv,event.csv,phase.csv). Use
          in combination with --profile.
          </description>
        </option>
        <option long-flag="dump-wf" argument="profile">
          <description>
          Dump processed waveforms of the catalog passed as argument 
          in the current working directory.
          The catalog can be a single file (containing seiscomp origin 
          ids) or a file triplet (station.csv,event.csv,phase.csv). Use 
          in combination with --profile.
          </description>
        </option>
        <option long-flag="load-profile-wf" argument="profile">
          <description>
          Load catalog waveforms from the configured recordstream and
          save them into the profile cache directory. Use in
          combination with --profile.
          </description>
        </option>
        <option long-flag="send-reload-profile-msg">
          <description>
          Send a message to any running scrtdd module requesting to 
          reload a specific profile passed as argument. Useful to reload the
          catalog without restarting the module.
          </description>
        </option>
      </group>
      <group name="ModeOptions">
        <option long-flag="profile" argument="profile"> 
          <description>
          To be used in combination with other options: select the 
          profile configuration to use.
          </description>
        </option>
        <option long-flag="clusters" argument="clusters">
          <description>
          Specify a list of files containing precomputed events/phases pairs.
          Use in combination with --reloc-catalog.
          </description>
        </option>
        <option long-flag="xcorr-cache">
          <description>
          Specify a file containing precomputed cross-correlation values.
          Use in combination with --reloc-catalog.
          </description>
        </option>
        <option long-flag="xmlout">
          <description>
          Enable XML output when combined with --reloc-catalog or --oring-id
          options.
          </description>
        </option>
      </group>
      <group name="Catalog">
        <option long-flag="dump-catalog" argument="catalog-file">
          <description>
          Dump the seiscomp event/origin id file passed as argument into
          a catalog file triplet (station.csv,event.csv,phase.csv).
          </description>
        </option>
        <option long-flag="merge-catalogs" argument="catalog-files">
          <description>
          Merge in a single catalog all the catalog file triplets
          (station1.csv,event1.csv,phase1.csv,station2.csv,event2.csv,
          phase2.csv,...) passed as arguments.
          </description>
        </option>
        <option long-flag="merge-catalogs-keepid" argument="catalog-files">
          <description>
          Similar to the --merge-catalogs option but events keep their ids. If
          multiple events share the same id, subsequent events will be
          discarded.
          </description>
        </option>
      </group>
    </command-line>
  </module>
</seiscomp>
